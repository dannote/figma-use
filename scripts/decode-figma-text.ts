import { initCodec, decodeMessage } from '../packages/cli/src/multiplayer/codec.ts'

await initCodec()

// First captured message (TEXT node creation)
const hex = '010102ecbe0d03b8082680a7f8f7bc33040201ecbe0d8c07cb0202313438303932343533353532313237313530370003bc92b1cb0604ac89b1cb0600ed020201010101030102024e6f6465496e73657274696f6e4265686176696f722d4d4f5553455f4452414700030000010202526573697a6553656c656374696f6e4265686176696f722d4d4f5553455f44524147000300000104027570646174652d656469742d696e666f00030000000201cb0200000001ecbe0d9cd93a020003ecbe0d8c072200040d0554657874001582000080210028850000900229496e74657200526567756c617200002a01000c0101000a0002000900070008000000e70201860000a08600002c060101496e74657200526567756c61720000027f74d1350314d483e2c7f8032c6638d047167efbeba0030f0649040005a006000801097f010000007f01800101a5010002ca0100cb01058c03018402009702018703000601087f0000000b860000a08600002c0c7f0000000083010010007f000000870000051a7f0000001d021f0026010100027f0000007f0000007f0000007f000000037f00000004010501009c03010e011b002e00ed020204010101010102024e6f6465496e73657274696f6e4265686176696f722d4d4f5553455f445241470003000000021b0e87032629ca01157f80018402a5011b2808030c1d1f1a2197022a9c038c03cb0104060200010101020102024e6f6465496e73657274696f6e4265686176696f722d4d4f5553455f4452414700030000010202526573697a6553656c656374696f6e4265686176696f722d4d4f5553455f44524147000300000002020b2e00010201020102024e6f6465496e73657274696f6e4265686176696f722d4d4f5553455f4452414700030000010202526573697a6553656c656374696f6e4265686176696f722d4d4f5553455f44524147000300000001040102024e6f6465496e73657274696f6e4265686176696f722d4d4f5553455f4452414700030000010202526573697a6553656c656374696f6e4265686176696f722d4d4f5553455f4452414700030000010402746578742d6c61796f75742d6f62736572766572000300000104026c61796f75742d64697274792d7465787400030000000201e70200010201020102024e6f6465496e73657274696f6e4265686176696f722d4d4f5553455f4452414700030000010202526573697a6553656c656374696f6e4265686176696f722d4d4f5553455f44524147000300000001050102024e6f6465496e73657274696f6e4265686176696f722d4d4f5553455f4452414700030000010202526573697a6553656c656374696f6e4265686176696f722d4d4f5553455f44524147000300000001040103746578742d6c61796f75742d6f62736572766572000300000104026c61796f75742d64697274792d7465787400030000010402746578742d656469746f722d6175746f2d72656e616d65000300000002010500000000'

const bytes = new Uint8Array(Buffer.from(hex, 'hex'))

console.log('Bytes length:', bytes.length)
console.log('First 20 bytes:', Buffer.from(bytes.slice(0, 20)).toString('hex'))

// Skip header (01 01 02 ...)
// Find where the real message starts
let offset = 0
while (offset < bytes.length && bytes[offset] !== 0x01) offset++

console.log('\nTrying to decode from offset', offset)

try {
  const decoded = decodeMessage(bytes.slice(offset))
  console.log('\nDecoded message:')
  console.log(JSON.stringify(decoded, null, 2))
} catch (e) {
  console.log('Decode failed:', e.message)
  
  // Try different offsets
  for (let i = 0; i < 50; i++) {
    try {
      const decoded = decodeMessage(bytes.slice(i))
      if (decoded?.nodeChanges?.length) {
        console.log(`\nSuccess at offset ${i}:`)
        console.log(JSON.stringify(decoded.nodeChanges[0], null, 2))
        break
      }
    } catch {}
  }
}
